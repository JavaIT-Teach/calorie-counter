<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calorie Counter ‚Äì Responsive Web App</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#f7f8fc; --panel:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --brand:#2563eb; --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444; --softShadow: 0 8px 30px rgba(2, 6, 23, 0.08); --radius: 16px; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Poppins, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;color:var(--ink);background:radial-gradient(1200px 600px at 20% -10%,#ffffff 0%,transparent 60%), radial-gradient(900px 500px at 100% 0%,#eaf1ff 0%,transparent 50%), var(--bg);} 

    header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(180%) blur(8px);background:linear-gradient(180deg,#ffffffcc,#ffffffb3 60%,#ffffff00);border-bottom:1px solid var(--line)}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:28px;font-weight:800;letter-spacing:.2px}
    .sub{color:var(--muted);margin-top:6px}

    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .tabs{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;align-items:center}
    .pill{padding:10px 16px;border-radius:999px;background:#f1f5f9;border:1px solid var(--line);cursor:pointer;user-select:none;transition:.2s ease;box-shadow:0 1px 0 #fff inset}
    .pill:hover{transform:translateY(-1px)}
    .pill.active{background:var(--brand); color:#fff; border-color:transparent; box-shadow:0 6px 16px rgba(37, 99, 235, .25)}

    .search{display:flex;margin-top:12px;background:var(--panel);border:1px solid var(--line);border-radius:12px;box-shadow:var(--softShadow);flex:1}
    .search input{flex:1;padding:12px 14px;border:0;outline:none;background:transparent;color:var(--ink)}
    .select{background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px 10px}

    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px}
    @media(min-width:760px){.grid{grid-template-columns:repeat(4,minmax(0,1fr));}}

    .tile{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:16px;min-height:118px;display:flex;flex-direction:column;gap:8px;justify-content:center;align-items:flex-start;box-shadow:var(--softShadow);transition:transform .15s ease, box-shadow .15s ease}
    .tile:hover{transform:translateY(-2px);box-shadow:0 12px 30px rgba(2,6,23,0.12)}
    .tile .emoji{font-size:22px;margin-right:6px}
    .tile .thumb{width:28px;height:28px;border-radius:8px;object-fit:cover;margin-right:6px;border:1px solid var(--line)}
    .tile .name{font-weight:700;display:flex;align-items:center}
    .favorite{color:var(--warn)}

    .totals{position:sticky;bottom:0;background:rgba(255,255,255,.85);backdrop-filter:saturate(160%) blur(6px);border-top:1px solid var(--line);display:flex;justify-content:space-around;padding:10px 8px}

    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center}

    .btn{background:var(--ok);color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;transition:transform .1s ease, filter .1s ease}
    .btn:hover{transform:translateY(-1px);filter:saturate(120%)}
    .btn.secondary{background:#f1f5f9;color:var(--ink);border:1px solid var(--line)}
    .btn.danger{background:var(--danger)}

    .list{display:flex;flex-direction:column;gap:10px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:var(--softShadow)}

    dialog::backdrop{background:rgba(15,23,42,.35)}
    dialog{border:0;border-radius:18px;background:var(--panel);color:var(--ink);width:min(560px,92vw);box-shadow:0 30px 80px rgba(2,6,23,.25);animation:pop .2s ease}
    @keyframes pop{from{transform:scale(.98);opacity:.0}to{transform:scale(1);opacity:1}}

    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .chip{background:#f8fafc;border:1px solid var(--line);border-radius:12px;padding:8px 12px;cursor:pointer;transition:.15s ease}
    .chip:hover{transform:translateY(-1px)}
    .chip.active{background:var(--brand);color:#fff;border-color:transparent}

    .field{background:#f8fafc;border:1px solid var(--line);border-radius:12px;padding:8px 12px;margin-top:8px}
    input[type="number"],input[type="text"],select{background:transparent;border:0;outline:none;color:var(--ink);width:100%;padding:6px 4px}

    .space{height:90px}
    .custom{display:inline-block;margin-left:6px;font-size:11px;color:#0f172a;background:#d1fae5;border:1px solid #10b981;padding:2px 8px;border-radius:999px}
    details.edit{margin-top:14px;border:1px solid var(--line);border-radius:12px;background:#fff;box-shadow:var(--softShadow)}
    details.edit>summary{cursor:pointer;list-style:none;padding:12px 16px;font-weight:700}
    details.edit[open]>summary{border-bottom:1px solid var(--line);background:#f8fafc}
    .edit-body{padding:12px 16px}
    .grid.small{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
    .field input[type="number"]{background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 10px;width:100%}

    /* Smooth enter/exit for folder changes */
    .fade-enter{opacity:.6; transition:opacity .18s ease}
    .fade-enter.active{opacity:1}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Cal Counter</h1>
      <div class="sub">Log foods fast. Numeric or metaphor portions.</div>
      <div class="toolbar">
        <div class="search"><input id="q" placeholder="Search foods (banana, salt, beef...)" /></div>
        <select id="folderFilter" class="select"></select>
      </div>
      <div class="tabs">
        <div class="pill active" data-screen="home">Home</div>
        <div class="pill" data-screen="log">Today</div>
        <div class="pill" data-screen="fav">Favorites</div>
        <button class="pill" id="addIngredientBtn" title="Create an ingredient">‚ûï Add ingredient</button>
        <button class="pill" id="manageFoldersBtn" title="Manage folders">üìÅ Folders</button>
      </div>
    </div>
  </header>

  <main class="container" id="main">
    <section id="home"></section>
    <section id="log" style="display:none"></section>
    <section id="fav" style="display:none"></section>
  </main>

  <div class="space"></div>
  <div class="totals" id="totals"></div>

  <!-- Item dialog -->
  <dialog id="itemDlg">
    <form method="dialog">
      <div class="container">
        <div class="row" style="justify-content:space-between">
          <div>
            <div id="itemName" style="font-weight:800;font-size:20px"></div>
            <div id="itemCat" class="muted" style="margin-top:6px"></div>
          </div>
          <button type="button" class="btn secondary" id="favBtn">‚òÖ</button>
        </div>

        <div class="card" style="margin-top:14px">
          <div class="muted">Quick portions</div>
          <div id="metaphorPane" class="chips"></div>
          <div class="muted" style="margin-top:10px">Units</div>
          <div class="chips" id="units"></div>
          <div class="field"><input id="numValue" type="number" placeholder="Enter value" min="0" step="any" /></div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="muted">Preview</div>
          <div id="previewGrams" style="font-weight:700;margin-top:6px"></div>
          <div class="row" style="justify-content:space-between;margin-top:8px;flex-wrap:wrap">
            <div>Cal <span id="pvCal"></span></div>
            <div>P <span id="pvPro"></span>g</div>
            <div>Sug <span id="pvSug"></span>g</div>
            <div>Fib <span id="pvFib"></span>g</div>
            <div>Fat <span id="pvFat"></span>g</div>
          </div>
          <div class="row" style="justify-content:flex-end;margin-top:12px;gap:8px">
            <button type="button" class="btn secondary" id="cancelBtn">Cancel</button>
            <button type="button" class="btn" id="addBtn">Add to Today</button>
          </div>
        </div>

        <details class="edit">
          <summary>‚úèÔ∏è Edit nutrients (per 100 g)</summary>
          <div class="edit-body">
            <div class="grid small">
              <div class="field"><label>Calories</label><input id="editCal" type="number" step="any"></div>
              <div class="field"><label>Protein (g)</label><input id="editPro" type="number" step="any"></div>
              <div class="field"><label>Sugars (g)</label><input id="editSug" type="number" step="any"></div>
              <div class="field"><label>Fiber (g)</label><input id="editFib" type="number" step="any"></div>
              <div class="field"><label>Fat (g)</label><input id="editFat" type="number" step="any"></div>
              <div class="field"><label>Density (g/ml) <span class="muted">optional</span></label><input id="editDensity" type="number" step="any"></div>
            </div>
            <div class="row" style="justify-content:flex-end;margin-top:12px;gap:8px">
              <button type="button" class="btn secondary" id="resetNutrients">Reset to default</button>
              <button type="button" class="btn" id="saveNutrients">Save changes</button>
            </div>
          </div>
        </details>
      </div>
    </form>
  </dialog>

  <!-- Create/Edit Ingredient dialog -->
  <dialog id="editDlg">
    <form method="dialog">
      <div class="container">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 style="margin:0;font-size:20px">Ingredient</h2>
          <div class="row">
            <button type="button" class="btn secondary" id="deleteIngBtn" title="Delete">üóëÔ∏è Delete</button>
            <button type="button" class="btn secondary" id="closeEdit">Cancel</button>
            <button type="button" class="btn" id="saveIngBtn">Save</button>
          </div>
        </div>

        <div class="grid small" style="margin-top:12px">
          <div class="field"><label>Name</label><input id="ingName" type="text" placeholder="e.g., Almonds"/></div>
          <div class="field"><label>Folder</label><select id="ingFolder"></select></div>
          <div class="field"><label>Emoji</label><input id="ingEmoji" type="text" placeholder="e.g., ü•ú" maxlength="4"/></div>
          <div class="field"><label>Picture</label><input id="ingImg" type="file" accept="image/*"/></div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="muted">Nutrients per 100 g</div>
          <div class="grid small" style="margin-top:8px">
            <div class="field"><label>Calories</label><input id="ingCal" type="number" step="any"></div>
            <div class="field"><label>Protein (g)</label><input id="ingPro" type="number" step="any"></div>
            <div class="field"><label>Sugars (g)</label><input id="ingSug" type="number" step="any"></div>
            <div class="field"><label>Fiber (g)</label><input id="ingFib" type="number" step="any"></div>
            <div class="field"><label>Fat (g)</label><input id="ingFat" type="number" step="any"></div>
            <div class="field"><label>Density (g/ml)</label><input id="ingDensity" type="number" step="any"></div>
          </div>
        </div>
      </div>
    </form>
  </dialog>

  <!-- Manage Folders dialog -->
  <dialog id="foldersDlg">
    <form method="dialog">
      <div class="container">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 style="margin:0;font-size:20px">Folders</h2>
          <div class="row">
            <button type="button" class="btn secondary" id="closeFolders">Close</button>
            <button type="button" class="btn" id="addFolderBtn">Add folder</button>
          </div>
        </div>
        <div id="foldersList" class="list" style="margin-top:10px"></div>
      </div>
    </form>
  </dialog>

  <script>
    const EMOJI = {'Condiment':'üßÇ','Sweetener':'üçØ','Fruit':'üçå','Meat':'ü•©','Fat':'ü´í','Grain':'üåæ','Protein':'üçó','Dairy':'ü•õ'};

    const BASE_FOODS = [
      { id:'salt', name:'Salt, iodized', category:'Condiment', per:'100g', nutrients:{cal:0, protein:0, sugar:0, fiber:0, fat:0}, density:1.2 },
      { id:'honey', name:'Honey', category:'Sweetener', per:'100g', nutrients:{cal:304, protein:0.3, sugar:82.4, fiber:0, fat:0}, density:1.42 },
      { id:'banana', name:'Banana (raw)', category:'Fruit', per:'100g', nutrients:{cal:89, protein:1.1, sugar:12.2, fiber:2.6, fat:0.3} },
      { id:'ground_beef_15', name:'Ground Beef 15% fat (cooked)', category:'Meat', per:'100g', nutrients:{cal:254, protein:26, sugar:0, fiber:0, fat:17} },
      { id:'olive_oil', name:'Olive Oil', category:'Fat', per:'100g', nutrients:{cal:884, protein:0, sugar:0, fiber:0, fat:100}, density:0.91 },
      { id:'oats', name:'Oats (dry)', category:'Grain', per:'100g', nutrients:{cal:389, protein:16.9, sugar:0, fiber:10.6, fat:6.9} },
      { id:'egg', name:'Egg (whole, cooked)', category:'Protein', per:'100g', nutrients:{cal:155, protein:13, sugar:1.1, fiber:0, fat:11} },
      { id:'chicken_breast', name:'Chicken Breast (cooked)', category:'Protein', per:'100g', nutrients:{cal:165, protein:31, sugar:0, fiber:0, fat:3.6} },
      { id:'greek_yogurt_0', name:'Greek Yogurt 0% (plain)', category:'Dairy', per:'100g', nutrients:{cal:59, protein:10.3, sugar:3.6, fiber:0, fat:0.4} },
    ];

    // ---------- Folders ----------
    const FK = 'cc.folders';
    const defaultFolders = [{id:'all', name:'All folders', img:'', builtin:true}, {id:'unsorted', name:'Unsorted', img:'', builtin:true}];
    const loadFolders = ()=> { const arr = JSON.parse(localStorage.getItem(FK)||'null'); return Array.isArray(arr)&&arr.length? arr : defaultFolders; };
    const saveFolders = (arr)=> localStorage.setItem(FK, JSON.stringify(arr));
    let folders = loadFolders();

    // ---------- Custom foods ----------
    const CFK = 'cc.customFoods';
    const loadCustomFoods = ()=> JSON.parse(localStorage.getItem(CFK)||'[]');
    const saveCustomFoods = (arr)=> localStorage.setItem(CFK, JSON.stringify(arr));
    let customFoods = loadCustomFoods();

    const allFoods = ()=> [...BASE_FOODS, ...customFoods];

    // ---------- Portion presets ----------
    const METAPHOR_PRESETS = {'pinch':{label:'pinch', grams:0.5},'thumb':{label:'thumb', grams:16},'palm':{label:'palm', grams:85},'fist':{label:'fist', grams:120},'cupped-hand':{label:'cupped-hand', grams:30},'drizzle':{label:'drizzle', grams:7},'splash':{label:'splash', grams:15}};

    const NUMERIC_UNITS = [
      { key:'g', label:'g', toGrams:(v, food)=> Number(v) },
      { key:'ml', label:'ml', toGrams:(v, food)=> Number(v) * (food?.density ?? 1) },
      { key:'tsp', label:'tsp', toGrams:(v, food)=> Number(v) * (food?.id==='honey'?7:(food?.id?.includes('oil')?4.5:4.2)) },
      { key:'tbsp', label:'tbsp', toGrams:(v, food)=> Number(v) * (food?.id==='honey'?21:(food?.id?.includes('oil')?13.5:14)) },
      { key:'cup', label:'cup', toGrams:(v, food)=> {let g=240; if(food?.id==='oats')g=80; if(food?.id==='greek_yogurt_0')g=245; if(food?.id?.includes('beef')||food?.id?.includes('chicken'))g=140; return Number(v)*g;} },
      { key:'piece', label:'piece', toGrams:(v, food)=> {let g=120; if(food?.id==='egg')g=50; return Number(v)*g;} },
    ];

    // ---------- Overrides ----------
    const OVK = 'cc.overrides';
    const getOverrides = ()=> JSON.parse(localStorage.getItem(OVK)||'{}');
    const getOverrideFor = (id)=> getOverrides()[id]||null;
    const saveOverrideFor = (id, data)=>{ const o=getOverrides(); o[id]=data; localStorage.setItem(OVK, JSON.stringify(o)); };
    const clearOverrideFor = (id)=>{ const o=getOverrides(); delete o[id]; localStorage.setItem(OVK, JSON.stringify(o)); };

    function effectiveFood(base){ const ov = getOverrideFor(base.id); const merged = { ...base }; if(ov){ merged.density = ov?.density ?? base.density; merged.nutrients = { ...base.nutrients, ...(ov?.nutrients||{}) }; } return merged; }
    function isOverridden(id){ return !!getOverrideFor(id); }

    // ---------- DOM refs ----------
    const $ = sel => document.querySelector(sel);
    const homeEl = $('#home');
    const logEl = $('#log');
    const favEl = $('#fav');
    const totalsEl = $('#totals');
    const q = $('#q');
    const folderFilter = $('#folderFilter');

    // scroll/selection state
    let folderScroll = JSON.parse(localStorage.getItem('cc.folderScroll')||'{}');
    let currentFolder = localStorage.getItem('cc.currentFolder') || 'all';

    let entries = JSON.parse(localStorage.getItem(keyForToday('entries'))||'[]');
    let favorites = JSON.parse(localStorage.getItem('favorites')||'[]');
    let selected = null; // effective
    let selectedBase = null; // base
    let mode = 'numeric';
    let metaphorChoice = 'fist';
    let numericUnit = 'g';
    let numericValue = 100;

    function keyForToday(s){ return `cc.${new Date().toISOString().slice(0,10)}.${s}`; }
    function save(){ localStorage.setItem(keyForToday('entries'), JSON.stringify(entries)); localStorage.setItem('favorites', JSON.stringify(favorites)); renderTotals(); renderLog(); renderFav(); }
    function perGram(n){ return {cal:n.cal/100, protein:n.protein/100, sugar:n.sugar/100, fiber:n.fiber/100, fat:n.fat/100}; }
    function round(v,d=1){ return Math.round(v*Math.pow(10,d))/Math.pow(10,d); }

    // ---------- Renderers ----------
    function renderFolderFilter(){
      folderFilter.innerHTML = folders.map(f=>`<option value="${f.id}">${f.name}</option>`).join('');
      folderFilter.value = currentFolder;
    }

    function renderHome(){
      const list = (q.value||'').toLowerCase();
      const chosen = currentFolder;
      let items = allFoods().filter(f=> f.name.toLowerCase().includes(list));
      if(chosen!=='all') items = items.filter(f=> f.folderId===chosen);

      const main = document.getElementById('main');
      main.classList.add('fade-enter');
      setTimeout(()=> main.classList.add('active'), 0);

      homeEl.innerHTML = `<div class="grid">${items.map(f=>{
        const emo = f.emoji || EMOJI[f.category] || 'üçΩÔ∏è';
        const img = f.img ? `<img class=\"thumb\" src=\"${f.img}\" alt=\"${f.name}\">` : `<span class=\"emoji\">${emo}</span>`;
        return `<button class=\"tile\" onclick='openItem("${f.id}")'>
          <div class=\"name\">${img} ${f.name}</div>
          <div class=\"muted\">${(folders.find(x=>x.id===f.folderId)?.name||f.category||'')}</div>
          <div style=\"margin-top:4px\">${favorites.includes(f.id)?'<span class="favorite">‚òÖ Favorite</span>':''}</div>
        </button>`;}).join('') || '<div class="muted">No items here yet.</div>'}</div>`;

      const y = Number(folderScroll[currentFolder]||0);
      setTimeout(()=> { window.scrollTo({top:y, behavior:'smooth'}); main.classList.remove('active'); main.classList.remove('fade-enter'); }, 120);
    }

    function renderLog(){
      logEl.innerHTML = `<div class="list">${entries.map(e=>{
        const f = findFood(e.food_id);
        const emo = (f?.emoji) || EMOJI[f?.category] || 'üçΩÔ∏è';
        const img = f?.img ? `<img class=\"thumb\" src=\"${f.img}\" alt=\"${f.name}\">` : `<span class=\"emoji\">${emo}</span>`;
        return `<div class=\"card\"> 
          <div class=\"row\" style=\"justify-content:space-between\"> 
            <div style=\"font-weight:700;display:flex;align-items:center\">${img} ${e.name}</div>
            <button class=\"btn danger\" onclick='delEntry("${e.id}")'>Delete</button>
          </div>
          <div class=\"muted\" style=\"margin-top:4px\">${Math.round(e.grams)} g</div>
          <div class=\"row\" style=\"justify-content:space-between;margin-top:8px;flex-wrap:wrap\">
            <div>Cal ${Math.round(e.nutrients.cal)}</div>
            <div>P ${round(e.nutrients.protein,1)}g</div>
            <div>Sug ${round(e.nutrients.sugar,1)}g</div>
            <div>Fib ${round(e.nutrients.fiber,1)}g</div>
            <div>Fat ${round(e.nutrients.fat,1)}g</div>
          </div>
        </div>`;}).join('')}</div>`;
    }

    function renderFav(){
      const items = allFoods().filter(f=> favorites.includes(f.id));
      favEl.innerHTML = `<div class="list">${items.map(f=>{
        const emo = f.emoji || EMOJI[f.category] || 'üçΩÔ∏è';
        const img = f.img ? `<img class=\"thumb\" src=\"${f.img}\" alt=\"${f.name}\">` : `<span class=\"emoji\">${emo}</span>`;
        return `<div class=\"card\"> 
          <div class=\"row\" style=\"justify-content:space-between;align-items:center\"> 
            <div> 
              <div style=\"font-weight:700;display:flex;align-items:center\">${img} ${f.name}</div>
              <div class=\"muted\">${(folders.find(x=>x.id===f.folderId)?.name||f.category||'')}</div>
            </div>
            <div class=\"row\" style=\"gap:8px\"> 
              <button class=\"btn secondary\" onclick='openItem("${f.id}")'>Add</button>
              <button class=\"btn\" onclick='toggleFav("${f.id}")' style=\"background:var(--warn)\">‚òÖ</button>
            </div>
          </div>
        </div>`;}).join('') || '<div class="muted">No favorites yet.</div>'}</div>`;
    }

    function renderTotals(){
      const t = entries.reduce((a,e)=>({cal:a.cal+e.nutrients.cal, protein:a.protein+e.nutrients.protein, sugar:a.sugar+e.nutrients.sugar, fiber:a.fiber+e.nutrients.fiber, fat:a.fat+e.nutrients.fat}),{cal:0,protein:0,sugar:0,fiber:0,fat:0});
      totalsEl.innerHTML = ['cal','protein','sugar','fiber','fat'].map(k=>{ const v=t[k]; return `<div style="text-align:center"><div class="muted" style="font-size:12px">${k.toUpperCase()}</div><div style="font-weight:800;font-size:18px">${k==='cal'?Math.round(v):round(v,1)}${k==='cal'?'':'g'}</div></div>` }).join('');
    }

    // ---------- Helpers ----------
    function findFood(id){ return allFoods().find(f=>f.id===id); }
    function slugify(s){ return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
    function fileToDataURL(file){ return new Promise(r=>{ const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(file); }); }

    // ---------- Item dialog ----------
    const dlg = document.getElementById('itemDlg');
    const pv = {g:$('#previewGrams'), cal:$('#pvCal'), pro:$('#pvPro'), sug:$('#pvSug'), fib:$('#pvFib'), fat:$('#pvFat')};
    const editFields = { cal:$('#editCal'), pro:$('#editPro'), sug:$('#editSug'), fib:$('#editFib'), fat:$('#editFat'), density:$('#editDensity') };

    function openItem(id){
      selectedBase = findFood(id);
      selected = { ...effectiveFood(selectedBase) };
      document.getElementById('itemName').textContent = `${(selectedBase.emoji||EMOJI[selectedBase.category]||'üçΩÔ∏è')} ${selectedBase.name}`;
      document.getElementById('itemCat').textContent = (folders.find(x=>x.id===selectedBase.folderId)?.name || selectedBase.category || '') + (isOverridden(selectedBase.id)? ' ¬∑ custom':'');
      preloadEditor(selected, selectedBase);
      if(selected.id==='banana'){ mode='metaphor'; metaphorChoice='fist'; }
      else if(selected.id==='olive_oil'){ mode='numeric'; numericUnit='tsp'; numericValue=1; }
      else { mode='numeric'; numericUnit='g'; numericValue=100; }
      renderMetaphors(); renderUnits(); updatePreview(); dlg.showModal();
    }
    function closeItem(){ dlg.close(); }
    dlg.addEventListener('click', (e)=>{ if(e.target===dlg) dlg.close(); }); // click outside to close

    function renderMetaphors(){ const pane=document.getElementById('metaphorPane'); pane.innerHTML = Object.keys(METAPHOR_PRESETS).map(k=>`<div class="chip ${metaphorChoice===k && mode==='metaphor' ? 'active':''}" onclick='chooseMetaphor("${k}")'>${METAPHOR_PRESETS[k].label}</div>`).join(''); }
    function chooseMetaphor(k){ mode='metaphor'; metaphorChoice=k; renderMetaphors(); renderUnits(); updatePreview(); }

    function renderUnits(){ const units=document.getElementById('units'); units.innerHTML = NUMERIC_UNITS.map(u=>`<div class="chip ${numericUnit===u.key && mode==='numeric' ? 'active':''}" onclick='chooseUnit("${u.key}")'>${u.label}</div>`).join(''); document.getElementById('numValue').value = numericValue; }
    function chooseUnit(k){ mode='numeric'; numericUnit=k; renderUnits(); renderMetaphors(); updatePreview(); }

    function gramsFromCurrent(){ if(!selected) return 0; if(mode==='metaphor') return METAPHOR_PRESETS[metaphorChoice]?.grams||0; const u = NUMERIC_UNITS.find(x=>x.key===numericUnit); const val = Number(document.getElementById('numValue').value || numericValue || 0); numericValue = val; return Math.max(0, u? u.toGrams(val, selected):0); }
    function nutrientsForGrams(g){ const pg = perGram(selected.nutrients); return {cal:pg.cal*g, protein:pg.protein*g, sugar:pg.sugar*g, fiber:pg.fiber*g, fat:pg.fat*g}; }
    function updatePreview(){ const g = gramsFromCurrent(); const n = nutrientsForGrams(g); pv.g.textContent = `${Math.round(g)} g`; pv.cal.textContent = `${Math.round(n.cal)}`; pv.pro.textContent = `${round(n.protein,1)}`; pv.sug.textContent = `${round(n.sugar,1)}`; pv.fib.textContent = `${round(n.fiber,1)}`; pv.fat.textContent = `${round(n.fat,1)}`; }

    document.getElementById('numValue').addEventListener('input', ()=>{ mode='numeric'; updatePreview(); renderUnits(); renderMetaphors(); });
    document.getElementById('addBtn').addEventListener('click', ()=>{ const g=gramsFromCurrent(); if(g<=0){ alert('Portion needed'); return; } const n=nutrientsForGrams(g); entries=[{ id:String(Date.now()), timestamp:new Date().toISOString(), food_id:selected.id, name:selectedBase.name, grams:g, nutrients:n }, ...entries]; save(); closeItem(); });

    function preloadEditor(effective, base){ editFields.cal.value=Number((effective.nutrients.cal??base.nutrients.cal)); editFields.pro.value=Number((effective.nutrients.protein??base.nutrients.protein)); editFields.sug.value=Number((effective.nutrients.sugar??base.nutrients.sugar)); editFields.fib.value=Number((effective.nutrients.fiber??base.nutrients.fiber)); editFields.fat.value=Number((effective.nutrients.fat??base.nutrients.fat)); editFields.density.value= Number((effective.density??base.density??'')); }
    function collectEdits(){ return { nutrients:{ cal:Number(editFields.cal.value||0), protein:Number(editFields.pro.value||0), sugar:Number(editFields.sug.value||0), fiber:Number(editFields.fib.value||0), fat:Number(editFields.fat.value||0) }, density: editFields.density.value? Number(editFields.density.value): undefined }; }
    function applyEditsToSelected(){ const ed=collectEdits(); selected={ ...selected, density: ed.density ?? selected.density, nutrients:{ ...selected.nutrients, ...ed.nutrients } }; updatePreview(); }
    document.getElementById('saveNutrients').addEventListener('click', ()=>{ const ed=collectEdits(); saveOverrideFor(selectedBase.id, ed); selected = effectiveFood(selectedBase); renderHome(); updatePreview(); alert('Saved custom nutrients for '+selectedBase.name); });
    document.getElementById('resetNutrients').addEventListener('click', ()=>{ clearOverrideFor(selectedBase.id); selected = { ...selectedBase }; preloadEditor(selected, selectedBase); renderHome(); updatePreview(); });
    Object.values(editFields).forEach(inp=> inp && inp.addEventListener('input', applyEditsToSelected));
    document.getElementById('cancelBtn').addEventListener('click', closeItem);

    $1document.getElementById('favBtn').addEventListener('click', ()=>{ toggleFav(selectedBase.id); ren
    // ---------- Ingredient dialog ----------
    const editDlg = document.getElementById('editDlg');
    const ingName=$('#ingName'), ingFolder=$('#ingFolder'), ingEmoji=$('#ingEmoji'), ingImg=$('#ingImg');
    const ingCal=$('#ingCal'), ingPro=$('#ingPro'), ingSug=$('#ingSug'), ingFib=$('#ingFib'), ingFat=$('#ingFat'), ingDensity=$('#ingDensity');
    let editingId = null;

    function populateFolderSelect(selectEl, selId){ selectEl.innerHTML = folders.filter(f=>!f.builtin || f.id==='unsorted').map(f=>`<option value="${f.id}">${f.name}</option>`).join(''); selectEl.value = selId || 'unsorted'; }

    document.getElementById('addIngredientBtn').addEventListener('click', ()=> openEdit());
    document.getElementById('closeEdit').addEventListener('click', (e)=>{ e.stopPropagation(); editDlg.close(); });
    editDlg.addEventListener('click', (e)=>{ if(e.target===editDlg) editDlg.close(); });

    document.getElementById('deleteIngBtn').addEventListener('click', (e)=>{ e.stopPropagation(); if(!editingId){ editDlg.close(); return; } if(confirm('Delete this ingredient?')){ customFoods = customFoods.filter(f=>f.id!==editingId); favorites = favorites.filter(id=>id!==editingId); saveCustomFoods(customFoods); save(); renderHome(); editDlg.close(); } });

    document.getElementById('saveIngBtn').addEventListener('click', async (e)=>{ e.stopPropagation(); const payload = await collectIngredientForm(); if(!payload) return; if(editingId){ customFoods = customFoods.map(f=> f.id===editingId ? { ...payload, id: editingId } : f); } else { const id = 'user_'+ slugify(payload.name) + '_' + Date.now(); customFoods = [{...payload, id}, ...customFoods]; } saveCustomFoods(customFoods); renderHome(); editDlg.close(); });

    function openEdit(id){
      editingId = id||null;
      const item = id ? customFoods.find(f=>f.id===id) : { name:'', folderId:'unsorted', emoji:'', img:'', nutrients:{cal:0,protein:0,sugar:0,fiber:0,fat:0}, density:'' };
      ingName.value=item.name||''; populateFolderSelect(ingFolder, item.folderId||'unsorted'); ingEmoji.value=item.emoji||''; ingCal.value=item.nutrients.cal||0; ingPro.value=item.nutrients.protein||0; ingSug.value=item.nutrients.sugar||0; ingFib.value=item.nutrients.fiber||0; ingFat.value=item.nutrients.fat||0; ingDensity.value=item.density||''; ingImg.value='';
      document.getElementById('deleteIngBtn').style.display = editingId? 'inline-block':'none';
      editDlg.showModal();
    }

    async function collectIngredientForm(){
      const name=ingName.value.trim(); const folderId=ingFolder.value||'unsorted'; if(!name){ alert('Name required'); return null; }
      let imgData = null; if(ingImg.files && ingImg.files[0]){ imgData = await fileToDataURL(ingImg.files[0]); }
      return { name, folderId, emoji: (ingEmoji.value||'').trim(), img: imgData || (editingId? customFoods.find(f=>f.id===editingId)?.img : ''), per:'100g', nutrients:{ cal:Number(ingCal.value||0), protein:Number(ingPro.value||0), sugar:Number(ingSug.value||0), fiber:Number(ingFib.value||0), fat:Number(ingFat.value||0) }, density: ingDensity.value? Number(ingDensity.value): undefined };
    }

    // ---------- Folder delete confirm modal ----------
    function persistFolders(){ saveFolders(folders); window.dispatchEvent(new Event('foldersUpdated')); }
    function confirmFolderDelete(folderId, anchorBtn){
      const folder = folders.find(f=>f.id===folderId); if(!folder || folder.builtin) return;
      const d = document.createElement('dialog');
      d.innerHTML = `<form method="dialog" style="padding:20px;max-width:360px">
        <h3 style="margin:0 0 8px 0">Delete this folder?</h3>
        <p>Ingredients will move to Unsorted.</p>
        <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:16px">
          <button type="button" id="cxl" class="btn secondary">Cancel</button>
          <button type="button" id="ok" class="btn danger">Delete</button>
        </div>
      </form>`;
      document.body.appendChild(d);
      const close = ()=>{ d.close(); d.remove(); anchorBtn?.focus(); };
      d.addEventListener('click', e=>{ if(e.target===d) close(); });
      d.querySelector('#cxl').addEventListener('click', e=>{ e.preventDefault(); close(); });
      d.querySelector('#ok').addEventListener('click', e=>{ e.preventDefault();
        customFoods = customFoods.map(it=> it.folderId===folderId? {...it, folderId:'unsorted'}:it);
        folders = folders.filter(f=> f.id!==folderId);
        persistFolders(); renderFolderFilter(); renderFoldersList(); renderHome();
        close();
      });
      d.showModal();
    }

    // ---------- Folders manager ----------
    const foldersDlg = document.getElementById('foldersDlg');
    const foldersList = document.getElementById('foldersList');
    document.getElementById('manageFoldersBtn').addEventListener('click', ()=>{ renderFoldersList(); foldersDlg.showModal(); });
    document.getElementById('closeFolders').addEventListener('click', (e)=>{ e.stopPropagation(); foldersDlg.close(); });
    foldersDlg.addEventListener('click', (e)=>{ if(e.target===foldersDlg) foldersDlg.close(); });
    document.getElementById('addFolderBtn').addEventListener('click', (e)=>{ e.stopPropagation(); const id='fld_'+Date.now(); folders.push({id,name:'New Folder',img:''}); persistFolders(); renderFolderFilter(); renderFoldersList(); });

    function renderFoldersList(){
      foldersList.innerHTML = folders.map(f=>{
        const disabled = f.builtin? 'disabled' : '';
        return `<div class="card" data-open="${f.id}">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div class="row" style="gap:8px;align-items:center">
              ${f.img? `<img class=\"thumb\" src=\"${f.img}\">` : '<span class="emoji">üìÅ</span>'}
              <input type="text" ${disabled} value="${f.name}" data-id="${f.id}" class="select" style="min-width:160px"/>
            </div>
            <div class="row" style="gap:8px">
              <label class="btn secondary" ${disabled} data-noclose>
                Change picture<input type="file" data-type="img" data-id="${f.id}" accept="image/*" style="display:none">
              </label>
              ${f.builtin? '' : `<button class="btn danger" data-action="del" data-id="${f.id}" data-noclose>Delete</button>`}
            </div>
          </div>
        </div>`;
      }).join('');

      // Open folder by clicking card area (not buttons/inputs)
      foldersList.querySelectorAll('.card').forEach(card=>{
        card.addEventListener('click', (e)=>{
          if(e.target.closest('[data-noclose]') || e.target.tagName==='INPUT') return;
          const id = card.getAttribute('data-open'); if(!id) return;
          folderScroll[currentFolder] = window.scrollY; localStorage.setItem('cc.folderScroll', JSON.stringify(folderScroll));
          currentFolder = id; localStorage.setItem('cc.currentFolder', currentFolder);
          renderFolderFilter(); renderHome();
        });
      });

      // Name edits
      foldersList.querySelectorAll('input.select').forEach(inp=>{
        inp.addEventListener('click', e=> e.stopPropagation());
        inp.addEventListener('input', (e)=>{ const id=e.target.dataset.id; const f=folders.find(x=>x.id===id); if(f){ f.name=e.target.value; persistFolders(); renderFolderFilter(); renderHome(); }});
      });
      // Picture change
      foldersList.querySelectorAll('input[data-type="img"]').forEach(inp=>{
        inp.addEventListener('click', e=> e.stopPropagation());
        inp.addEventListener('change', async (e)=>{ const id=e.target.dataset.id; const file=e.target.files[0]; if(!file) return; const data=await fileToDataURL(file); const f=folders.find(x=>x.id===id); if(f){ f.img=data; persistFolders(); renderFoldersList(); } e.target.value=''; });
      });
      // Delete with confirm; stop propagation/default
      foldersList.querySelectorAll('button[data-action="del"]').forEach(btn=>{
        btn.addEventListener('click', (ev)=>{ ev.stopPropagation(); ev.preventDefault(); confirmFolderDelete(btn.dataset.id, btn); });
      });
    }

    // ---------- App wiring ----------
    function delEntry(id){ entries = entries.filter(e=>e.id!==id); save(); }
    document.querySelectorAll('.pill').forEach(p=>p.addEventListener('click', ()=>{ document.querySelectorAll('.pill').forEach(x=>x.classList.remove('active')); p.classList.add('active'); const t=p.dataset.screen; ['home','log','fav'].forEach(id=> document.getElementById(id).style.display = (id===t?'block':'none')); }));
    q.addEventListener('input', renderHome);
    folderFilter.addEventListener('change', ()=>{
      folderScroll[currentFolder] = window.scrollY;
      localStorage.setItem('cc.folderScroll', JSON.stringify(folderScroll));
      currentFolder = folderFilter.value;
      localStorage.setItem('cc.currentFolder', currentFolder);
      renderHome();
    });
    // track scroll position continuously
    window.addEventListener('scroll', ()=>{ folderScroll[currentFolder] = window.scrollY; localStorage.setItem('cc.folderScroll', JSON.stringify(folderScroll)); });

    // initial
    renderFolderFilter();
    renderHome(); renderTotals(); renderLog(); renderFav();

    // expose (if needed)
    window.openItem = openItem; window.chooseMetaphor = chooseMetaphor; window.chooseUnit = chooseUnit;
  </script>
</body>
</html>
